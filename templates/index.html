<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONNX2TFLite æ¨¡å‹è½¬æ¢å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            color: #1d1d1f;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header {
            text-align: center;
            padding: 40px 0 30px;
            background: linear-gradient(135deg, rgba(0,122,255,0.05) 0%, rgba(88,86,214,0.05) 100%);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 8px;
            letter-spacing: -0.015em;
        }

        .header p {
            font-size: 1.125rem;
            font-weight: 400;
            color: #86868b;
            max-width: 600px;
            margin: 0 auto;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            padding: 0 0 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 64px rgba(0, 0, 0, 0.12);
        }

        .card h2 {
            color: #1d1d1f;
            margin-bottom: 16px;
            font-size: 1.375rem;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .upload-area {
            border: 2px dashed #d2d2d7;
            border-radius: 12px;
            padding: 32px 24px;
            text-align: center;
            background: rgba(255, 255, 255, 0.6);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #007aff;
            background: rgba(0, 122, 255, 0.05);
            transform: scale(1.01);
        }

        .upload-area.dragging {
            border-color: #007aff;
            background: rgba(0, 122, 255, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            margin: 4px;
            letter-spacing: -0.01em;
        }

        .btn:hover {
            background: #0056cc;
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 122, 255, 0.3);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success {
            background: #28cd41;
        }

        .btn-success:hover {
            background: #1fa334;
            box-shadow: 0 12px 24px rgba(40, 205, 65, 0.3);
        }

        .btn-download {
            background: #ff3b30;
        }

        .btn-download:hover {
            background: #cc2e24;
            box-shadow: 0 12px 24px rgba(255, 59, 48, 0.3);
        }

        .btn-quantize {
            background: #ff9500;
        }

        .btn-quantize:hover {
            background: #cc7700;
            box-shadow: 0 12px 24px rgba(255, 149, 0, 0.3);
        }

        .layer-selection-grid {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 12px;
            background: rgba(248, 248, 248, 0.8);
        }

        .options {
            margin: 20px 0;
        }

        .option-item {
            margin: 8px 0;
            display: flex;
            align-items: center;
        }

        .option-item input[type="checkbox"] {
            margin-right: 8px;
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #007aff;
        }

        .option-item label {
            cursor: pointer;
            font-size: 0.875rem;
            color: #1d1d1f;
            font-weight: 400;
        }

        /* æ ¡å‡†æ•°æ®ä¸Šä¼ æ ·å¼ */
        .calibration-upload-area:hover {
            border-color: #005bb5 !important;
            background: rgba(0, 122, 255, 0.1) !important;
            transform: scale(1.02);
        }

        .calibration-upload-area.dragging {
            border-color: #005bb5 !important;
            background: rgba(0, 122, 255, 0.15) !important;
            transform: scale(1.03);
        }

        .calibration-upload-section {
            transition: all 0.3s ease;
        }

        .calibration-upload-section:hover {
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.2);
        }

        .model-info {
            background: rgba(248, 248, 248, 0.8);
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
            backdrop-filter: blur(10px);
        }

        .info-section {
            margin-bottom: 12px;
        }

        .info-section h3 {
            color: #1d1d1f;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: -0.01em;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .info-label {
            font-weight: 500;
            color: #1d1d1f;
        }

        .info-value {
            color: #86868b;
            font-family: 'SF Mono', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        }

        .status-message {
            padding: 10px 16px;
            border-radius: 8px;
            margin: 12px 0;
            display: none;
            font-weight: 500;
        }

        .status-message.success {
            background: rgba(40, 205, 65, 0.1);
            color: #1fa334;
            border: 1px solid rgba(40, 205, 65, 0.2);
        }

        .status-message.error {
            background: rgba(255, 59, 48, 0.1);
            color: #cc2e24;
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        .status-message.info {
            background: rgba(0, 122, 255, 0.1);
            color: #007aff;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top: 3px solid #007aff;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .node-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .node-stat {
            background: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #007aff;
            backdrop-filter: blur(10px);
        }

        .node-stat .count {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 2px;
        }

        .node-stat .label {
            font-size: 0.75rem;
            color: #86868b;
            font-weight: 500;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .nodes-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 12px;
        }

        .node-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 3px solid #007aff;
            backdrop-filter: blur(10px);
        }

        .node-item .node-type {
            font-weight: 600;
            color: #1d1d1f;
            font-size: 1rem;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .card {
                padding: 32px 24px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 60px 0 40px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1.125rem;
            }
            
            .card {
                padding: 24px 20px;
            }
            
            .upload-area {
                padding: 40px 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”„ ONNX2TFLite æ¨¡å‹è½¬æ¢å·¥å…·</h1>
            <p>è½»æ¾å°† ONNX æ¨¡å‹è½¬æ¢ä¸º TensorFlow Lite æ ¼å¼</p>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>ğŸ“¤ ä¸Šä¼ æ¨¡å‹</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <p style="font-size: 1rem; font-weight: 600; margin-bottom: 4px; color: #1d1d1f;"><strong>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  ONNX æ¨¡å‹</strong></p>
                    <p style="color: #86868b; font-size: 0.875rem;">æ”¯æŒ .onnx æ ¼å¼ï¼Œæœ€å¤§ 500MB</p>
                    <input type="file" id="fileInput" accept=".onnx">
                </div>

                <div class="status-message" id="statusMessage"></div>

                <div class="options" id="conversionOptions" style="display: none;">
                    <h3 style="color: #1d1d1f; margin-bottom: 12px; font-weight: 600;">è½¬æ¢é€‰é¡¹</h3>
                    <div class="option-item">
                        <input type="checkbox" id="allowInputsStripping">
                        <label for="allowInputsStripping">å…è®¸ç§»é™¤ä¸å¿…è¦çš„è¾“å…¥</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="keepIoFormat">
                        <label for="keepIoFormat">ä¿æŒè¾“å…¥è¾“å‡ºæ ¼å¼ (NCHW)</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="qdqAware">
                        <label for="qdqAware">QDQ æ„ŸçŸ¥è½¬æ¢</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="enableQuantization">
                        <label for="enableQuantization">ğŸ”¥ å¯ç”¨é‡åŒ– (å‡å°æ¨¡å‹å¤§å°)</label>
                    </div>
                </div>

                <div class="options" id="quantizationOptions" style="display: none;">
                    <h3 style="color: #1d1d1f; margin-bottom: 12px; font-weight: 600;">ğŸ¯ é‡åŒ–é…ç½®</h3>
                    <p style="color: #86868b; font-size: 0.875rem; margin-bottom: 16px;">é€‰æ‹©è¦é‡åŒ–çš„å±‚ç±»å‹ã€‚ä½¿ç”¨çœŸå®æ ¡å‡†æ•°æ®å¯ä»¥æ˜¾è‘—æé«˜é‡åŒ–ç²¾åº¦ã€‚</p>
                    
                    <!-- æ ¡å‡†æ•°æ®ä¸Šä¼ åŒºåŸŸ -->
                    <div class="calibration-upload-section" style="margin-bottom: 20px; padding: 16px; background: rgba(0, 122, 255, 0.05); border-radius: 8px; border: 1px solid rgba(0, 122, 255, 0.2);">
                        <h4 style="color: #007aff; margin-bottom: 8px; font-weight: 600; font-size: 1rem;">ğŸ“¦ æ ¡å‡†æ•°æ® (å¯é€‰ä½†æ¨è)</h4>
                        <p style="color: #86868b; font-size: 0.8rem; margin-bottom: 12px;">
                            ä¸Šä¼ åŒ…å«.npyæ–‡ä»¶çš„ZIPåŒ…ä½œä¸ºæ ¡å‡†æ•°æ®ï¼Œå¯æ˜¾è‘—æé«˜é‡åŒ–ç²¾åº¦ã€‚ä¸ä¸Šä¼ å°†ä½¿ç”¨éšæœºæ•°æ®ã€‚
                        </p>
                        
                        <div class="calibration-upload-area" id="calibrationUploadArea" style="border: 2px dashed #007aff; border-radius: 8px; padding: 16px; text-align: center; background: rgba(255, 255, 255, 0.8); cursor: pointer; transition: all 0.3s;">
                            <div class="upload-icon" style="font-size: 24px; margin-bottom: 8px;">ğŸ“</div>
                            <p style="margin: 0; color: #007aff; font-weight: 500;">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ ¡å‡†æ•°æ®ZIPæ–‡ä»¶</p>
                            <p style="margin: 4px 0 0; color: #86868b; font-size: 0.75rem;">æ”¯æŒåŒ…å«å¤šä¸ª.npyæ–‡ä»¶çš„ZIPåŒ…</p>
                            <input type="file" id="calibrationFileInput" accept=".zip" style="display: none;">
                        </div>
                        
                        <div id="calibrationFileInfo" style="margin-top: 12px; display: none;">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: rgba(52, 199, 89, 0.1); border-radius: 6px; border: 1px solid rgba(52, 199, 89, 0.3);">
                                <div style="display: flex; align-items: center;">
                                    <span style="color: #34c759; margin-right: 8px;">âœ“</span>
                                    <span id="calibrationFileName" style="color: #1d1d1f; font-weight: 500;"></span>
                                    <span id="calibrationFileCount" style="color: #86868b; margin-left: 8px; font-size: 0.875rem;"></span>
                                </div>
                                <button id="removeCalibritionFile" style="background: none; border: none; color: #ff3b30; cursor: pointer; font-size: 16px; padding: 4px;">Ã—</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å±‚é€‰æ‹©åŒºåŸŸ -->
                    <div class="layer-selection-section">
                        <h4 style="color: #1d1d1f; margin-bottom: 12px; font-weight: 600;">ğŸ”§ é‡åŒ–å±‚é€‰æ‹©</h4>
                        <div class="option-item">
                            <input type="checkbox" id="quantAll" checked>
                            <label for="quantAll"><strong>å…¨é€‰/å…¨ä¸é€‰</strong></label>
                        </div>
                        
                        <div style="border-top: 1px solid rgba(0,0,0,0.1); margin: 12px 0; padding-top: 12px;">
                            <div class="layer-selection-grid" id="layerSelectionGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px; margin-top: 8px;">
                                <!-- Layer selection checkboxes will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" id="convertBtn" style="display: none;">
                        ğŸ”„ å¼€å§‹è½¬æ¢
                    </button>
                    <button class="btn btn-download" id="downloadBtn" style="display: none;">
                        â¬‡ï¸ ä¸‹è½½ TFLite æ¨¡å‹
                    </button>
                    <button class="btn btn-download" id="downloadQuantizedBtn" style="display: none; background: #ff9500;">
                        ğŸ”¥ ä¸‹è½½é‡åŒ– TFLite æ¨¡å‹
                    </button>
                    <button class="btn" id="convertToCppBtn" style="display: none; background: #34c759;">
                        ğŸ  è½¬C++æ–‡ä»¶
                    </button>
                    <button class="btn" id="convertQuantizedToCppBtn" style="display: none; background: #34c759;">
                        ğŸ  é‡åŒ–æ¨¡å‹è½¬C++
                    </button>
                    <button class="btn btn-download" id="downloadCppBtn" style="display: none; background: #5ac8fa;">
                        ğŸ“º ä¸‹è½½C++æ–‡ä»¶
                    </button>
                    <button class="btn btn-download" id="downloadQuantizedCppBtn" style="display: none; background: #5ac8fa;">
                        ğŸ“º ä¸‹è½½é‡åŒ–C++æ–‡ä»¶
                    </button>
                </div>

                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p style="margin-top: 12px; color: #007aff; font-weight: 500;">å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ“Š æ¨¡å‹ä¿¡æ¯</h2>
                <div id="modelInfo" style="color: #86868b; text-align: center; padding: 40px 20px; font-size: 1rem;">
                    ä¸Šä¼ æ¨¡å‹åå°†æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                </div>
            </div>
        </div>

        <div class="card full-width" id="detailedInfo" style="display: none;">
            <h2>ğŸ” è¯¦ç»†ç»“æ„</h2>
            <div id="detailedContent"></div>
        </div>
        
        <div class="card full-width" id="conversionReport" style="display: none;">
            <h2>ğŸ“‹ è½¬æ¢æŠ¥å‘Š</h2>
            <div id="reportContent"></div>
        </div>
    </div>

    <script>
        let uploadedFilename = null;
        let tfliteFilename = null;
        let quantizedTfliteFilename = null;
        let cppFilename = null;
        let quantizedCppFilename = null;
        let calibrationDataFilename = null;
        let availableLayers = [];

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const statusMessage = document.getElementById('statusMessage');
        const modelInfo = document.getElementById('modelInfo');
        const convertBtn = document.getElementById('convertBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadQuantizedBtn = document.getElementById('downloadQuantizedBtn');
        const convertToCppBtn = document.getElementById('convertToCppBtn');
        const convertQuantizedToCppBtn = document.getElementById('convertQuantizedToCppBtn');
        const downloadCppBtn = document.getElementById('downloadCppBtn');
        const downloadQuantizedCppBtn = document.getElementById('downloadQuantizedCppBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const conversionOptions = document.getElementById('conversionOptions');
        const quantizationOptions = document.getElementById('quantizationOptions');
        const detailedInfo = document.getElementById('detailedInfo');
        const conversionReport = document.getElementById('conversionReport');
        const enableQuantizationCheckbox = document.getElementById('enableQuantization');

        // æ ¡å‡†æ•°æ®ä¸Šä¼ ç›¸å…³å…ƒç´ 
        const calibrationUploadArea = document.getElementById('calibrationUploadArea');
        const calibrationFileInput = document.getElementById('calibrationFileInput');
        const calibrationFileInfo = document.getElementById('calibrationFileInfo');
        const calibrationFileName = document.getElementById('calibrationFileName');
        const calibrationFileCount = document.getElementById('calibrationFileCount');
        const removeCalibritionFile = document.getElementById('removeCalibritionFile');
        const quantAllCheckbox = document.getElementById('quantAll');
        const layerSelectionGrid = document.getElementById('layerSelectionGrid');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragging');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragging');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragging');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        // æ ¡å‡†æ•°æ®ä¸Šä¼ äº‹ä»¶å¤„ç†å™¨
        calibrationUploadArea.addEventListener('click', () => calibrationFileInput.click());
        
        // æ ¡å‡†æ•°æ®æ‹–æ‹½ä¸Šä¼ æ”¯æŒ
        calibrationUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            calibrationUploadArea.classList.add('dragging');
        });

        calibrationUploadArea.addEventListener('dragleave', () => {
            calibrationUploadArea.classList.remove('dragging');
        });

        calibrationUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            calibrationUploadArea.classList.remove('dragging');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleCalibrationDataUpload(files[0]);
            }
        });
        
        calibrationFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleCalibrationDataUpload(e.target.files[0]);
            }
        });

        removeCalibritionFile.addEventListener('click', () => {
            calibrationDataFilename = null;
            calibrationFileInfo.style.display = 'none';
            calibrationUploadArea.style.display = 'block';
        });

        async function handleCalibrationDataUpload(file) {
            if (!file.name.toLowerCase().endsWith('.zip')) {
                alert('è¯·ä¸Šä¼  .zip æ ¼å¼çš„æ ¡å‡†æ•°æ®æ–‡ä»¶');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            loadingIndicator.style.display = 'block';
            showStatus('ä¸Šä¼ æ ¡å‡†æ•°æ®ä¸­...', 'info');

            try {
                const response = await fetch('/upload_calibration_data', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    calibrationDataFilename = data.filename;
                    calibrationFileName.textContent = file.name;
                    calibrationFileCount.textContent = `(${data.npy_files_count} ä¸ª.npyæ–‡ä»¶)`;
                    
                    calibrationUploadArea.style.display = 'none';
                    calibrationFileInfo.style.display = 'block';
                    
                    showStatus('æ ¡å‡†æ•°æ®ä¸Šä¼ æˆåŠŸï¼é‡åŒ–ç²¾åº¦å°†æ˜¾è‘—æå‡', 'success');
                } else {
                    showStatus(data.error, 'error');
                }
            } catch (error) {
                showStatus('æ ¡å‡†æ•°æ®ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        async function handleFileUpload(file) {
            if (!file.name.endsWith('.onnx')) {
                showStatus('è¯·ä¸Šä¼  .onnx æ ¼å¼çš„æ–‡ä»¶', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            loadingIndicator.style.display = 'block';
            showStatus('ä¸Šä¼ ä¸­...', 'info');

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    uploadedFilename = data.filename;
                    showStatus('âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼', 'success');
                    displayModelInfo(data.model_info);
                    convertBtn.style.display = 'inline-block';
                    conversionOptions.style.display = 'block';
                    downloadBtn.style.display = 'none';
                    downloadQuantizedBtn.style.display = 'none';
                    convertToCppBtn.style.display = 'none';
                    convertQuantizedToCppBtn.style.display = 'none';
                    downloadCppBtn.style.display = 'none';
                    downloadQuantizedCppBtn.style.display = 'none';
                    // é‡ç½®æ–‡ä»¶åå˜é‡
                    tfliteFilename = null;
                    quantizedTfliteFilename = null;
                    cppFilename = null;
                    quantizedCppFilename = null;
                } else {
                    showStatus('âŒ ' + (data.error || 'ä¸Šä¼ å¤±è´¥'), 'error');
                }
            } catch (error) {
                showStatus('âŒ ä¸Šä¼ å‡ºé”™: ' + error.message, 'error');
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function displayModelInfo(info) {
            if (info.error) {
                modelInfo.innerHTML = `<div style="color: red;">é”™è¯¯: ${info.error}</div>`;
                return;
            }

            let html = '<div class="model-info">';
            
            html += '<div class="info-section"><h3>åŸºæœ¬ä¿¡æ¯</h3>';
            html += `<div class="info-item"><span class="info-label">IR ç‰ˆæœ¬:</span><span class="info-value">${info.ir_version}</span></div>`;
            html += `<div class="info-item"><span class="info-label">ç”Ÿäº§è€…:</span><span class="info-value">${info.producer_name || 'N/A'} ${info.producer_version || ''}</span></div>`;
            
            if (info.opset_imports && info.opset_imports.length > 0) {
                const opsets = info.opset_imports.map(op => `${op.domain}: v${op.version}`).join(', ');
                html += `<div class="info-item"><span class="info-label">Opset:</span><span class="info-value">${opsets}</span></div>`;
            }
            html += '</div>';

            html += '<div class="info-section"><h3>è¾“å…¥</h3>';
            info.inputs.forEach(inp => {
                html += `<div class="info-item"><span class="info-label">${inp.name}:</span><span class="info-value">[${inp.shape.join(', ')}]</span></div>`;
            });
            html += '</div>';

            html += '<div class="info-section"><h3>è¾“å‡º</h3>';
            info.outputs.forEach(out => {
                html += `<div class="info-item"><span class="info-label">${out.name}:</span><span class="info-value">[${out.shape.join(', ')}]</span></div>`;
            });
            html += '</div>';

            html += '<div class="info-section"><h3>æ¨¡å‹ç»Ÿè®¡</h3>';
            html += `<div class="info-item"><span class="info-label">æ€»èŠ‚ç‚¹æ•°:</span><span class="info-value">${info.total_nodes}</span></div>`;
            html += `<div class="info-item"><span class="info-label">åˆå§‹åŒ–å™¨:</span><span class="info-value">${info.total_initializers}</span></div>`;
            html += '</div>';

            if (info.node_types) {
                html += '<div class="info-section"><h3>ç®—å­ç±»å‹ç»Ÿè®¡</h3>';
                html += '<div class="node-stats">';
                for (const [opType, count] of Object.entries(info.node_types)) {
                    html += `<div class="node-stat"><div class="count">${count}</div><div class="label">${opType}</div></div>`;
                }
                html += '</div></div>';
            }

            html += '</div>';
            modelInfo.innerHTML = html;

            // Update available layers for quantization
            if (info.node_types) {
                updateAvailableLayers(info.node_types);
            }

            if (info.nodes && info.nodes.length > 0) {
                displayDetailedNodes(info.nodes, info.nodes_truncated, info.total_nodes_count);
            }
        }

        function displayDetailedNodes(nodes, truncated, totalCount) {
            detailedInfo.style.display = 'block';
            let html = '<div class="nodes-list">';
            
            if (truncated) {
                html += `<p style="color: #007aff; margin-bottom: 12px; font-weight: 500;">æ˜¾ç¤ºå‰ ${nodes.length} ä¸ªèŠ‚ç‚¹ï¼ˆå…± ${totalCount} ä¸ªï¼‰</p>`;
            }
            
            nodes.forEach(node => {
                html += `<div class="node-item">`;
                html += `<div><span class="node-type">${node.op_type}</span> - ${node.name}</div>`;
                html += `<div style="font-size: 0.75rem; color: #86868b; margin-top: 4px;">`;
                html += `è¾“å…¥: ${node.inputs.join(', ')}<br>`;
                html += `è¾“å‡º: ${node.outputs.join(', ')}`;
                html += `</div></div>`;
            });
            
            html += '</div>';
            document.getElementById('detailedContent').innerHTML = html;
        }

        convertBtn.addEventListener('click', async () => {
            if (!uploadedFilename) {
                showStatus('è¯·å…ˆä¸Šä¼ æ¨¡å‹', 'error');
                return;
            }

            const options = {
                allow_inputs_stripping: document.getElementById('allowInputsStripping').checked,
                keep_io_format: document.getElementById('keepIoFormat').checked,
                qdq_aware_conversion: document.getElementById('qdqAware').checked
            };

            const enableQuantization = enableQuantizationCheckbox.checked;

            loadingIndicator.style.display = 'block';
            showStatus('æ­£åœ¨è½¬æ¢æ¨¡å‹ï¼Œè¯·ç¨å€™...', 'info');
            convertBtn.disabled = true;
            downloadBtn.style.display = 'none';
            downloadQuantizedBtn.style.display = 'none';
            convertToCppBtn.style.display = 'none';
            convertQuantizedToCppBtn.style.display = 'none';
            downloadCppBtn.style.display = 'none';
            downloadQuantizedCppBtn.style.display = 'none';

            try {
                // Regular conversion
                const response = await fetch('/convert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: uploadedFilename,
                        options: options
                    })
                });

                const data = await response.json();

                if (data.success) {
                    tfliteFilename = data.tflite_filename;
                    
                    // ä¿å­˜è½¬æ¢æ•°æ®ä¾›ç²¾åº¦å¯¹æ¯”ä½¿ç”¨
                    currentConversionData = {
                        tflite_filename: data.tflite_filename,
                        quantized_tflite_filename: null
                    };
                    
                    const sizeInfo = `ONNX: ${(data.onnx_size / 1024 / 1024).toFixed(2)} MB â†’ TFLite: ${(data.tflite_size / 1024 / 1024).toFixed(2)} MB (å‹ç¼© ${data.compression_ratio})`;
                    showStatus('âœ… åŸºç¡€è½¬æ¢æˆåŠŸï¼' + sizeInfo, 'success');
                    downloadBtn.style.display = 'inline-block';
                    convertToCppBtn.style.display = 'inline-block';
                    
                    // æ˜¾ç¤ºè½¬æ¢æŠ¥å‘Š
                    if (data.conversion_report) {
                        displayConversionReport(data.conversion_report);
                    }

                    // Perform quantization if enabled
                    if (enableQuantization) {
                        await performQuantization();
                    }
                } else {
                    showStatus('âŒ è½¬æ¢å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showStatus('âŒ è½¬æ¢å‡ºé”™: ' + error.message, 'error');
            } finally {
                loadingIndicator.style.display = 'none';
                convertBtn.disabled = false;
            }
        });

        async function performQuantization() {
            try {
                if (calibrationDataFilename) {
                    showStatus('ğŸ”¥ æ­£åœ¨ä½¿ç”¨çœŸå®æ•°æ®è¿›è¡Œé‡åŒ–å¤„ç†...', 'info');
                } else {
                    showStatus('ğŸ”¥ æ­£åœ¨ä½¿ç”¨éšæœºæ•°æ®è¿›è¡Œé‡åŒ–å¤„ç†...', 'info');
                }
                
                // Get selected layers
                const selectedLayers = [];
                const layerCheckboxes = document.querySelectorAll('#layerSelectionGrid input[type="checkbox"]:checked');
                layerCheckboxes.forEach(checkbox => {
                    selectedLayers.push(checkbox.value);
                });

                const requestBody = {
                    filename: uploadedFilename,
                    selected_layers: selectedLayers
                };
                
                // å¦‚æœæœ‰æ ¡å‡†æ•°æ®æ–‡ä»¶ï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
                if (calibrationDataFilename) {
                    requestBody.calibration_data_filename = calibrationDataFilename;
                }

                const quantResponse = await fetch('/quantize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const quantData = await quantResponse.json();

                if (quantData.success) {
                    quantizedTfliteFilename = quantData.quantized_tflite_filename;
                    
                    // æ›´æ–°è½¬æ¢æ•°æ®ï¼Œæ·»åŠ é‡åŒ–æ¨¡å‹æ–‡ä»¶å
                    if (currentConversionData) {
                        currentConversionData.quantized_tflite_filename = quantData.quantized_tflite_filename;
                    }
                    
                    const quantSizeInfo = `é‡åŒ–å: ${(quantData.quantized_tflite_size / 1024 / 1024).toFixed(2)} MB (é¢å¤–å‹ç¼© ${quantData.additional_compression_ratio})`;
                    const dataSourceInfo = calibrationDataFilename ? ' (ä½¿ç”¨çœŸå®æ ¡å‡†æ•°æ®)' : ' (ä½¿ç”¨éšæœºæ ¡å‡†æ•°æ®)';
                    showStatus('ğŸ”¥ é‡åŒ–æˆåŠŸï¼' + quantSizeInfo + dataSourceInfo, 'success');
                    downloadQuantizedBtn.style.display = 'inline-block';
                    convertQuantizedToCppBtn.style.display = 'inline-block';
                    
                    // æ˜¾ç¤ºé‡åŒ–æŠ¥å‘Š
                    if (quantData.quantization_report) {
                        displayQuantizationReport(quantData.quantization_report);
                    }
                } else {
                    showStatus('âŒ é‡åŒ–å¤±è´¥: ' + (quantData.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showStatus('âŒ é‡åŒ–å‡ºé”™: ' + error.message, 'error');
            }
        }

        downloadBtn.addEventListener('click', () => {
            if (tfliteFilename) {
                window.location.href = `/download/${tfliteFilename}`;
            }
        });

        downloadQuantizedBtn.addEventListener('click', () => {
            if (quantizedTfliteFilename) {
                window.location.href = `/download/${quantizedTfliteFilename}`;
            }
        });

        // C++è½¬æ¢æŒ‰é’®äº‹ä»¶
        convertToCppBtn.addEventListener('click', async () => {
            if (!tfliteFilename) {
                showStatus('âŒ æœªæ‰¾åˆ°TFLiteæ¨¡å‹æ–‡ä»¶', 'error');
                return;
            }

            try {
                loadingIndicator.style.display = 'block';
                showStatus('ğŸ”„ æ­£åœ¨è½¬æ¢TFLiteæ¨¡å‹ä¸ºC++æ–‡ä»¶...', 'info');

                const response = await fetch('/convert_to_cpp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tflite_filename: tfliteFilename
                    })
                });

                const result = await response.json();

                if (result.success) {
                    cppFilename = result.cpp_filename;
                    showStatus('âœ… ' + result.message, 'success');
                    downloadCppBtn.style.display = 'inline-block';
                } else {
                    showStatus('âŒ C++è½¬æ¢å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showStatus('âŒ C++è½¬æ¢å‡ºé”™: ' + error.message, 'error');
            } finally {
                loadingIndicator.style.display = 'none';
            }
        });

        // é‡åŒ–æ¨¡å‹C++è½¬æ¢æŒ‰é’®äº‹ä»¶
        convertQuantizedToCppBtn.addEventListener('click', async () => {
            if (!quantizedTfliteFilename) {
                showStatus('âŒ æœªæ‰¾åˆ°é‡åŒ–TFLiteæ¨¡å‹æ–‡ä»¶', 'error');
                return;
            }

            try {
                loadingIndicator.style.display = 'block';
                showStatus('ğŸ”„ æ­£åœ¨è½¬æ¢é‡åŒ–TFLiteæ¨¡å‹ä¸ºC++æ–‡ä»¶...', 'info');

                const response = await fetch('/convert_to_cpp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tflite_filename: quantizedTfliteFilename
                    })
                });

                const result = await response.json();

                if (result.success) {
                    quantizedCppFilename = result.cpp_filename;
                    showStatus('âœ… ' + result.message, 'success');
                    downloadQuantizedCppBtn.style.display = 'inline-block';
                } else {
                    showStatus('âŒ é‡åŒ–æ¨¡å‹C++è½¬æ¢å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showStatus('âŒ é‡åŒ–æ¨¡å‹C++è½¬æ¢å‡ºé”™: ' + error.message, 'error');
            } finally {
                loadingIndicator.style.display = 'none';
            }
        });

        // C++æ–‡ä»¶ä¸‹è½½æŒ‰é’®äº‹ä»¶
        downloadCppBtn.addEventListener('click', () => {
            if (cppFilename) {
                window.location.href = `/download/${cppFilename}`;
            }
        });

        // é‡åŒ–æ¨¡å‹C++æ–‡ä»¶ä¸‹è½½æŒ‰é’®äº‹ä»¶
        downloadQuantizedCppBtn.addEventListener('click', () => {
            if (quantizedCppFilename) {
                window.location.href = `/download/${quantizedCppFilename}`;
            }
        });

        // Enable/disable quantization options
        enableQuantizationCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                quantizationOptions.style.display = 'block';
                populateLayerSelection();
            } else {
                quantizationOptions.style.display = 'none';
            }
        });

        // Select all/none layers for quantization
        quantAllCheckbox.addEventListener('change', (e) => {
            const layerCheckboxes = document.querySelectorAll('#layerSelectionGrid input[type="checkbox"]');
            layerCheckboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });

        function populateLayerSelection() {
            if (availableLayers.length === 0) return;
            
            layerSelectionGrid.innerHTML = '';
            
            availableLayers.forEach(layer => {
                const div = document.createElement('div');
                div.className = 'option-item';
                div.innerHTML = `
                    <input type="checkbox" id="layer_${layer}" value="${layer}" checked>
                    <label for="layer_${layer}">${layer}</label>
                `;
                layerSelectionGrid.appendChild(div);
            });
        }

        function updateAvailableLayers(nodeTypes) {
            // Define quantizable layer types based on the QDQQuantizer default_op_types_to_quantize
            const quantizableOps = [
                'Add', 'ArgMax', 'ArgMin', 'AveragePool', 'Clip', 'Concat', 'Conv', 'ConvTranspose',
                'Equal', 'Expand', 'Flatten', 'Gather', 'GatherND', 'Gemm', 'GlobalAveragePool',
                'GlobalMaxPool', 'Greater', 'GreaterOrEqual', 'HardSwish', 'LeakyRelu', 'Less',
                'LessOrEqual', 'LogSoftmax', 'MatMul', 'Max', 'MaxPool', 'Min', 'Mul', 'Pad',
                'PRelu', 'ReduceProd', 'ReduceSum', 'Relu', 'Reshape', 'ScatterND', 'Sigmoid',
                'Softmax', 'Split', 'Squeeze', 'Sub', 'Tanh', 'Transpose', 'Unsqueeze', 'Where'
            ];
            
            availableLayers = Object.keys(nodeTypes).filter(opType => 
                quantizableOps.includes(opType)
            ).sort();
        }

        function displayConversionReport(report) {
            conversionReport.style.display = 'block';
            
            let html = '<div class="model-info">';
            
            // åŸºæœ¬è½¬æ¢ä¿¡æ¯
            html += '<div class="info-section"><h3>ğŸ”„ è½¬æ¢æ¦‚è¦</h3>';
            html += `<div class="info-item"><span class="info-label">è½¬æ¢çŠ¶æ€:</span><span class="info-value" style="color: #28cd41; font-weight: 600;">${report.status}</span></div>`;
            html += `<div class="info-item"><span class="info-label">è½¬æ¢æ—¶é—´:</span><span class="info-value">${report.conversion_time}</span></div>`;
            html += `<div class="info-item"><span class="info-label">æºæ ¼å¼:</span><span class="info-value">${report.original_format}</span></div>`;
            html += `<div class="info-item"><span class="info-label">ç›®æ ‡æ ¼å¼:</span><span class="info-value">${report.target_format}</span></div>`;
            html += `<div class="info-item"><span class="info-label">è½¬æ¢æ—¶é—´:</span><span class="info-value">${report.timestamp}</span></div>`;
            html += '</div>';
            
            // æ–‡ä»¶å¤§å°å¯¹æ¯”
            html += '<div class="info-section"><h3>ğŸ“Š æ–‡ä»¶å¤§å°å¯¹æ¯”</h3>';
            html += `<div class="info-item"><span class="info-label">åŸå§‹æ–‡ä»¶ (ONNX):</span><span class="info-value">${report.file_sizes.onnx_size_mb}</span></div>`;
            html += `<div class="info-item"><span class="info-label">è½¬æ¢å (TFLite):</span><span class="info-value">${report.file_sizes.tflite_size_mb}</span></div>`;
            html += `<div class="info-item"><span class="info-label">å‹ç¼©æ¯”ä¾‹:</span><span class="info-value" style="color: #28cd41; font-weight: 600;">${report.file_sizes.compression_ratio}</span></div>`;
            html += `<div class="info-item"><span class="info-label">èŠ‚çœç©ºé—´:</span><span class="info-value" style="color: #28cd41;">${report.file_sizes.size_reduction}</span></div>`;
            html += '</div>';
            
            // ç²¾åº¦å¯¹æ¯”éƒ¨åˆ†
            html += '<div class="info-section"><h3>ğŸ¯ æ¨¡å‹ç²¾åº¦å¯¹æ¯”</h3>';
            html += '<div id="accuracySection">';
            if (report.accuracy_comparison) {
                html += renderAccuracyComparison(report.accuracy_comparison);
            } else {
                html += `<div class="info-item">
                    <button id="runAccuracyTest" onclick="runAccuracyComparison()" 
                            style="background: #007aff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px;">
                        ğŸ”¬ è¿è¡Œç²¾åº¦å¯¹æ¯”æµ‹è¯• (100ç»„éšæœºæ•°æ®)
                    </button>
                </div>`;
            }
            html += '</div></div>';
            
            // æ¨¡å‹ç»“æ„ä¿¡æ¯
            html += '<div class="info-section"><h3>ğŸ—ï¸ æ¨¡å‹ç»“æ„</h3>';
            html += `<div class="info-item"><span class="info-label">æ€»èŠ‚ç‚¹æ•°:</span><span class="info-value">${report.model_structure.total_nodes}</span></div>`;
            html += `<div class="info-item"><span class="info-label">åˆå§‹åŒ–å™¨:</span><span class="info-value">${report.model_structure.total_initializers}</span></div>`;
            html += `<div class="info-item"><span class="info-label">è¾“å…¥å¼ é‡:</span><span class="info-value">${report.model_structure.input_tensors}</span></div>`;
            html += `<div class="info-item"><span class="info-label">è¾“å‡ºå¼ é‡:</span><span class="info-value">${report.model_structure.output_tensors}</span></div>`;
            html += '</div>';
            
            // ç®—å­ç±»å‹ç»Ÿè®¡
            if (Object.keys(report.model_structure.node_types).length > 0) {
                html += '<div class="info-section"><h3>âš™ï¸ ç®—å­ç±»å‹åˆ†å¸ƒ</h3>';
                html += '<div class="node-stats">';
                const sortedNodeTypes = Object.entries(report.model_structure.node_types)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 12); // åªæ˜¾ç¤ºå‰12ä¸ªæœ€å¸¸ç”¨çš„ç®—å­
                
                for (const [opType, count] of sortedNodeTypes) {
                    const percentage = ((count / report.model_structure.total_nodes) * 100).toFixed(1);
                    html += `<div class="node-stat">`;
                    html += `<div class="count">${count}</div>`;
                    html += `<div class="label">${opType}</div>`;
                    html += `<div style="font-size: 0.7rem; color: #86868b; margin-top: 2px;">${percentage}%</div>`;
                    html += `</div>`;
                }
                html += '</div></div>';
            }
            
            // è½¬æ¢é€‰é¡¹
            if (Object.keys(report.conversion_options).length > 0) {
                html += '<div class="info-section"><h3>âš™ï¸ è½¬æ¢é€‰é¡¹</h3>';
                for (const [key, value] of Object.entries(report.conversion_options)) {
                    const displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const displayValue = value ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨';
                    const valueColor = value ? '#28cd41' : '#86868b';
                    html += `<div class="info-item"><span class="info-label">${displayKey}:</span><span class="info-value" style="color: ${valueColor};">${displayValue}</span></div>`;
                }
                html += '</div>';
            }
            
            html += '</div>';
            
            document.getElementById('reportContent').innerHTML = html;
        }
        
        // å…¨å±€å˜é‡å­˜å‚¨å½“å‰è½¬æ¢ç»“æœ
        let currentConversionData = null;
        
        function runAccuracyComparison() {
            if (!currentConversionData || !uploadedFilename) {
                showStatus('æ— æ³•è¿è¡Œç²¾åº¦æµ‹è¯•ï¼šç¼ºå°‘å¿…è¦çš„æ–‡ä»¶ä¿¡æ¯', 'error');
                return;
            }
            
            const button = document.getElementById('runAccuracyTest');
            if (button) {
                button.innerHTML = 'ğŸ”„ æ­£åœ¨è¿è¡Œç²¾åº¦æµ‹è¯•...';
                button.disabled = true;
            }
            
            showStatus('ğŸ”¬ æ­£åœ¨ç”Ÿæˆ100ç»„éšæœºæ•°æ®å¹¶è¿›è¡Œæ¨¡å‹æ¨ç†...', 'info');
            
            const requestData = {
                filename: uploadedFilename,
                tflite_filename: currentConversionData.tflite_filename,
                quantized_tflite_filename: currentConversionData.quantized_tflite_filename || null,
                num_samples: 100
            };
            
            fetch('/accuracy_comparison', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (button) {
                    button.disabled = false;
                }
                
                if (data.success) {
                    showStatus('âœ… ç²¾åº¦æµ‹è¯•å®Œæˆ', 'success');
                    // æ›´æ–°ç²¾åº¦å¯¹æ¯”éƒ¨åˆ†
                    const accuracySection = document.getElementById('accuracySection');
                    if (accuracySection) {
                        accuracySection.innerHTML = renderAccuracyComparison(data.accuracy_report);
                    }
                } else {
                    showStatus('âŒ ç²¾åº¦æµ‹è¯•å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                    if (button) {
                        button.innerHTML = 'ğŸ”¬ è¿è¡Œç²¾åº¦å¯¹æ¯”æµ‹è¯• (100ç»„éšæœºæ•°æ®)';
                    }
                }
            })
            .catch(error => {
                if (button) {
                    button.disabled = false;
                    button.innerHTML = 'ğŸ”¬ è¿è¡Œç²¾åº¦å¯¹æ¯”æµ‹è¯• (100ç»„éšæœºæ•°æ®)';
                }
                showStatus('âŒ ç²¾åº¦æµ‹è¯•å‡ºé”™: ' + error.message, 'error');
            });
        }
        
        function renderAccuracyComparison(accuracyReport) {
            let html = '';
            
            // æµ‹è¯•å‚æ•°
            html += '<div style="background: rgba(0, 122, 255, 0.05); padding: 16px; border-radius: 8px; margin: 8px 0;">';
            html += '<h4 style="margin: 0 0 8px 0; color: #007aff;">ğŸ“Š æµ‹è¯•å‚æ•°</h4>';
            html += `<div class="info-item"><span class="info-label">æµ‹è¯•æ ·æœ¬æ•°:</span><span class="info-value">${accuracyReport.test_parameters.num_samples}</span></div>`;
            html += `<div class="info-item"><span class="info-label">æµ‹è¯•æ—¶é—´:</span><span class="info-value">${accuracyReport.test_parameters.comparison_time}</span></div>`;
            html += `<div class="info-item"><span class="info-label">æˆåŠŸå¯¹æ¯”æ•°:</span><span class="info-value">${accuracyReport.accuracy_metrics.successful_samples}</span></div>`;
            html += '</div>';
            
            // ONNX vs TFLite å¯¹æ¯”ç»“æœ
            if (accuracyReport.accuracy_metrics.onnx_vs_tflite && Object.keys(accuracyReport.accuracy_metrics.onnx_vs_tflite).length > 0) {
                const tfliteMetrics = accuracyReport.accuracy_metrics.onnx_vs_tflite;
                html += '<div style="background: rgba(40, 205, 65, 0.05); padding: 16px; border-radius: 8px; margin: 8px 0;">';
                html += '<h4 style="margin: 0 0 8px 0; color: #28cd41;">ğŸŸ¢ ONNX vs TFLite ç²¾åº¦å¯¹æ¯”</h4>';
                html += `<div class="info-item"><span class="info-label">å¹³å‡ç›¸å¯¹è¯¯å·®:</span><span class="info-value">${(tfliteMetrics.mean_relative_error * 100).toFixed(4)}%</span></div>`;
                html += `<div class="info-item"><span class="info-label">æœ€å¤§ç›¸å¯¹è¯¯å·®:</span><span class="info-value">${(tfliteMetrics.max_relative_error * 100).toFixed(4)}%</span></div>`;
                html += `<div class="info-item"><span class="info-label">å¹³å‡ç»å¯¹è¯¯å·® (MAE):</span><span class="info-value">${tfliteMetrics.mean_mae.toFixed(6)}</span></div>`;
                html += `<div class="info-item"><span class="info-label">æœ€å¤§ç»å¯¹è¯¯å·®:</span><span class="info-value">${tfliteMetrics.max_max_error.toFixed(6)}</span></div>`;
                html += `<div class="info-item"><span class="info-label">å‡æ–¹è¯¯å·® (MSE):</span><span class="info-value">${tfliteMetrics.mean_mse.toFixed(8)}</span></div>`;
                html += '</div>';
            }
            
            // ONNX vs é‡åŒ–TFLite å¯¹æ¯”ç»“æœ
            if (accuracyReport.accuracy_metrics.onnx_vs_quantized_tflite && Object.keys(accuracyReport.accuracy_metrics.onnx_vs_quantized_tflite).length > 0) {
                const quantizedMetrics = accuracyReport.accuracy_metrics.onnx_vs_quantized_tflite;
                html += '<div style="background: rgba(255, 149, 0, 0.05); padding: 16px; border-radius: 8px; margin: 8px 0;">';
                html += '<h4 style="margin: 0 0 8px 0; color: #ff9500;">ğŸŸ  ONNX vs é‡åŒ–TFLite ç²¾åº¦å¯¹æ¯”</h4>';
                html += `<div class="info-item"><span class="info-label">å¹³å‡ç›¸å¯¹è¯¯å·®:</span><span class="info-value">${(quantizedMetrics.mean_relative_error * 100).toFixed(4)}%</span></div>`;
                html += `<div class="info-item"><span class="info-label">æœ€å¤§ç›¸å¯¹è¯¯å·®:</span><span class="info-value">${(quantizedMetrics.max_relative_error * 100).toFixed(4)}%</span></div>`;
                html += `<div class="info-item"><span class="info-label">å¹³å‡ç»å¯¹è¯¯å·® (MAE):</span><span class="info-value">${quantizedMetrics.mean_mae.toFixed(6)}</span></div>`;
                html += `<div class="info-item"><span class="info-label">æœ€å¤§ç»å¯¹è¯¯å·®:</span><span class="info-value">${quantizedMetrics.max_max_error.toFixed(6)}</span></div>`;
                html += `<div class="info-item"><span class="info-label">å‡æ–¹è¯¯å·® (MSE):</span><span class="info-value">${quantizedMetrics.mean_mse.toFixed(8)}</span></div>`;
                html += '</div>';
            }
            
            // æ¨ç†ç»“æœç»Ÿè®¡
            html += '<div style="background: rgba(142, 142, 147, 0.05); padding: 16px; border-radius: 8px; margin: 8px 0;">';
            html += '<h4 style="margin: 0 0 8px 0; color: #8e8e93;">ğŸ“ˆ æ¨ç†ç»“æœç»Ÿè®¡</h4>';
            html += `<div class="info-item"><span class="info-label">ONNXæˆåŠŸæ¨ç†:</span><span class="info-value">${accuracyReport.inference_results.onnx_successful_inferences}/${accuracyReport.test_parameters.num_samples}</span></div>`;
            html += `<div class="info-item"><span class="info-label">TFLiteæˆåŠŸæ¨ç†:</span><span class="info-value">${accuracyReport.inference_results.tflite_successful_inferences}/${accuracyReport.test_parameters.num_samples}</span></div>`;
            if (accuracyReport.inference_results.quantized_tflite_successful_inferences > 0) {
                html += `<div class="info-item"><span class="info-label">é‡åŒ–TFLiteæˆåŠŸæ¨ç†:</span><span class="info-value">${accuracyReport.inference_results.quantized_tflite_successful_inferences}/${accuracyReport.test_parameters.num_samples}</span></div>`;
            }
            html += '</div>';
            
            // ç²¾åº¦è¯„ä¼°ç»“è®º
            html += '<div style="background: rgba(0, 122, 255, 0.1); padding: 16px; border-radius: 8px; margin: 8px 0; border-left: 4px solid #007aff;">';
            html += '<h4 style="margin: 0 0 8px 0; color: #007aff;">ğŸ¯ ç²¾åº¦è¯„ä¼°ç»“è®º</h4>';
            
            if (accuracyReport.accuracy_metrics.onnx_vs_tflite) {
                const tfliteError = accuracyReport.accuracy_metrics.onnx_vs_tflite.mean_relative_error;
                const tfliteAssessment = tfliteError < 0.001 ? 'ğŸŸ¢ éå¸¸ä¼˜ç§€' : 
                                       tfliteError < 0.01 ? 'ğŸŸ¡ è‰¯å¥½' : 'ğŸ”´ éœ€è¦æ³¨æ„';
                html += `<div class="info-item"><span class="info-label">TFLiteè½¬æ¢ç²¾åº¦:</span><span class="info-value">${tfliteAssessment} (${(tfliteError * 100).toFixed(4)}%)</span></div>`;
            }
            
            if (accuracyReport.accuracy_metrics.onnx_vs_quantized_tflite) {
                const quantError = accuracyReport.accuracy_metrics.onnx_vs_quantized_tflite.mean_relative_error;
                const quantAssessment = quantError < 0.01 ? 'ğŸŸ¢ éå¸¸ä¼˜ç§€' : 
                                      quantError < 0.05 ? 'ğŸŸ¡ è‰¯å¥½' : 'ğŸ”´ éœ€è¦æ³¨æ„';
                html += `<div class="info-item"><span class="info-label">é‡åŒ–ç²¾åº¦:</span><span class="info-value">${quantAssessment} (${(quantError * 100).toFixed(4)}%)</span></div>`;
            }
            
            html += '</div>';
            
            return html;
        }

        function displayQuantizationReport(report) {
            // è¿½åŠ é‡åŒ–æŠ¥å‘Šåˆ°ç°æœ‰çš„è½¬æ¢æŠ¥å‘Šä¸­
            const reportContent = document.getElementById('reportContent');
            if (!reportContent) return;
            
            let html = '<div class="info-section" style="border-top: 2px solid #ff9500; margin-top: 20px; padding-top: 20px;"><h3>ğŸ”¥ é‡åŒ–å¤„ç†æŠ¥å‘Š</h3>';
            
            // é‡åŒ–æ¦‚è¦
            html += `<div class="info-item"><span class="info-label">é‡åŒ–çŠ¶æ€:</span><span class="info-value" style="color: #ff9500; font-weight: 600;">${report.status}</span></div>`;
            html += `<div class="info-item"><span class="info-label">é‡åŒ–æ—¶é—´:</span><span class="info-value">${report.quantization_time}</span></div>`;
            html += `<div class="info-item"><span class="info-label">é‡åŒ–æ–¹æ³•:</span><span class="info-value">${report.quantization_method}</span></div>`;
            html += `<div class="info-item"><span class="info-label">é‡åŒ–å±‚ç±»å‹:</span><span class="info-value">${report.quantized_layer_types.join(', ')}</span></div>`;
            html += `<div class="info-item"><span class="info-label">å¤„ç†æ—¶é—´:</span><span class="info-value">${report.timestamp}</span></div>`;
            
            // æ ¡å‡†æ•°æ®éªŒè¯æŠ¥å‘Š
            if (report.calibration_data_validation) {
                const validation = report.calibration_data_validation;
                html += '<h4 style="margin: 16px 0 8px 0; color: #007acc;">ğŸ“‹ æ ¡å‡†æ•°æ®éªŒè¯æŠ¥å‘Š</h4>';
                
                // éªŒè¯ç»Ÿè®¡
                html += `<div class="info-item"><span class="info-label">æ€»æ–‡ä»¶æ•°:</span><span class="info-value">${validation.total_files}</span></div>`;
                html += `<div class="info-item"><span class="info-label">æœ‰æ•ˆæ–‡ä»¶:</span><span class="info-value" style="color: green;">${validation.valid_files}</span></div>`;
                html += `<div class="info-item"><span class="info-label">æ— æ•ˆæ–‡ä»¶:</span><span class="info-value" style="color: red;">${validation.invalid_files}</span></div>`;
                html += `<div class="info-item"><span class="info-label">æˆåŠŸåŠ è½½æ ·æœ¬:</span><span class="info-value" style="color: green; font-weight: 600;">${validation.loaded_samples}</span></div>`;
                
                // æœŸæœ›çš„è¾“å…¥è§„æ ¼
                if (validation.expected_specs) {
                    html += '<div style="margin: 12px 0;"><strong>æœŸæœ›è¾“å…¥è§„æ ¼ (batch=1):</strong></div>';
                    for (const [inputName, specs] of Object.entries(validation.expected_specs)) {
                        html += `<div class="info-item" style="margin-left: 20px;">
                            <span class="info-label">${inputName}:</span>
                            <span class="info-value">shape=${JSON.stringify(specs.shape)}, dtype=${specs.dtype.name || specs.dtype}</span>
                        </div>`;
                    }
                }
                
                // éªŒè¯é”™è¯¯ä¿¡æ¯
                if (validation.validation_errors && validation.validation_errors.length > 0) {
                    html += '<div style="margin: 12px 0;"><strong style="color: red;">éªŒè¯é”™è¯¯:</strong></div>';
                    const errorsToShow = validation.validation_errors.slice(0, 5); // æ˜¾ç¤ºå‰5ä¸ªé”™è¯¯
                    for (const error of errorsToShow) {
                        html += `<div style="margin-left: 20px; color: red; font-size: 0.9em;">â€¢ ${error}</div>`;
                    }
                    if (validation.validation_errors.length > 5) {
                        html += `<div style="margin-left: 20px; color: red; font-size: 0.9em;">... è¿˜æœ‰ ${validation.validation_errors.length - 5} ä¸ªé”™è¯¯</div>`;
                    }
                }
                
                // æ–‡ä»¶è¯¦ç»†ä¿¡æ¯ï¼ˆåªæ˜¾ç¤ºå‰10ä¸ªï¼‰
                if (validation.file_details && validation.file_details.length > 0) {
                    html += '<div style="margin: 12px 0;"><strong>æ–‡ä»¶éªŒè¯è¯¦æƒ…:</strong></div>';
                    html += '<table style="width: 100%; font-size: 0.9em; border-collapse: collapse;">';
                    html += '<tr style="background-color: #f5f5f5;"><th style="padding: 5px; border: 1px solid #ddd;">æ–‡ä»¶å</th><th style="padding: 5px; border: 1px solid #ddd;">çŠ¶æ€</th><th style="padding: 5px; border: 1px solid #ddd;">å®é™…å½¢çŠ¶</th><th style="padding: 5px; border: 1px solid #ddd;">åŒ¹é…è¾“å…¥</th></tr>';
                    
                    const detailsToShow = validation.file_details.slice(0, 10);
                    for (const detail of detailsToShow) {
                        const statusColor = detail.status === 'success' ? 'green' : 'red';
                        const shapeStr = detail.actual_shape ? JSON.stringify(detail.actual_shape) : 'N/A';
                        const matchedInput = detail.matched_input || 'N/A';
                        
                        html += `<tr>
                            <td style="padding: 5px; border: 1px solid #ddd;">${detail.filename}</td>
                            <td style="padding: 5px; border: 1px solid #ddd; color: ${statusColor};">${detail.status}</td>
                            <td style="padding: 5px; border: 1px solid #ddd;">${shapeStr}</td>
                            <td style="padding: 5px; border: 1px solid #ddd;">${matchedInput}</td>
                        </tr>`;
                    }
                    
                    html += '</table>';
                    if (validation.file_details.length > 10) {
                        html += `<div style="margin: 8px 0; font-size: 0.9em; color: #666;">... è¿˜æœ‰ ${validation.file_details.length - 10} ä¸ªæ–‡ä»¶</div>`;
                    }
                }
            }
            
            // é‡åŒ–æ•ˆæœ
            html += '<h4 style="margin: 16px 0 8px 0; color: #ff9500;">ğŸ“Š é‡åŒ–æ•ˆæœå¯¹æ¯”</h4>';
            html += `<div class="info-item"><span class="info-label">åŸå§‹ONNX:</span><span class="info-value">${report.file_sizes.original_onnx_size_mb}</span></div>`;
            html += `<div class="info-item"><span class="info-label">é‡åŒ–ONNX:</span><span class="info-value">${report.file_sizes.quantized_onnx_size_mb}</span></div>`;
            html += `<div class="info-item"><span class="info-label">é‡åŒ–TFLite:</span><span class="info-value">${report.file_sizes.quantized_tflite_size_mb}</span></div>`;
            html += `<div class="info-item"><span class="info-label">æ€»å‹ç¼©æ¯”:</span><span class="info-value" style="color: #ff9500; font-weight: 600;">${report.file_sizes.additional_compression_ratio}</span></div>`;
            
            html += '</div>';
            
            // æ·»åŠ åˆ°æŠ¥å‘Šå†…å®¹æœ«å°¾
            reportContent.innerHTML += html;
        }
        
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>